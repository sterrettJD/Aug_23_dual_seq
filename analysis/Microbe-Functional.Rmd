---
title: "Microbe Functional"
author: "John Sterrett"
date: "2023-10-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load("tidyverse",
               "ggplot2")
# set ggplot theme
theme_set(theme_bw())
```

# Load Data
```{r}
gf <- data.table::fread("../seq.f0.0.r0.0.nonhost.humann/all_genefamilies.tsv",
                        data.table=F)
rownames(gf) <- gf$`# Gene Family`
gf$`# Gene Family` <- NULL
gf <- gf %>% mutate_all(as.numeric)
colnames(gf) <- colnames(gf) %>% 
    gsub(pattern="_Abundance-RPKs", replacement="")

gf.notax.rows <- rownames(gf) %>% grepl(pattern="\\|")
gf.notax <- gf[gf.notax.rows,]
gf.tax <- gf[!gf.notax.rows,]

metadata <- data.table::fread("../16s-data/16S_meta.txt",
                        data.table=F)
```

# Unmapped
```{r}
sample.sums <- colSums(gf)
percent.unmapped <- as.numeric((gf["UNMAPPED",]/sample.sums) * 100)
names(percent.unmapped) <- colnames(gf)

hist(percent.unmapped)

knitr::kable(percent.unmapped, col.names="Percent unmapped")
```

# PCoA {.tabset}

## Aitchison distance {.tabset}
```{r calc_dist}
notax.aitch <- robCompositions::aDist(t(gf.notax)+1)
tax.aitch <- robCompositions::aDist(t(gf.tax)+1)
```

### No-tax by HIV
```{r pcoa_aitch_HIV}
notax.aitch.pcoa <- ape::pcoa(notax.aitch)

notax.aitch.pcoa.dat <- merge(notax.aitch.pcoa$vectors, metadata,
                              by.x="row.names", by.y="Sample_ID")
notax.aitch.pcoa.dat %>%
    ggplot(mapping=aes(Axis.1, Axis.2, color=HIV_Status, label=Row.names)) +
    geom_point(size=4) +
    ggrepel::geom_label_repel(color="black")
    
```

### No-tax by Cohort
```{r pcoa_aitch_Cohort}
notax.aitch.pcoa.dat <- merge(notax.aitch.pcoa$vectors, metadata,
                              by.x="row.names", by.y="Sample_ID")
notax.aitch.pcoa.dat %>%
    ggplot(mapping=aes(Axis.1, Axis.2, color=Cohort, label=Row.names)) +
    geom_point(size=4) +
    ggrepel::geom_label_repel(color="black")
    
```


### With tax by HIV
```{r pcoa_aitch_HIV_tax}
tax.aitch.pcoa <- ape::pcoa(tax.aitch)

tax.aitch.pcoa.dat <- merge(tax.aitch.pcoa$vectors, metadata,
                              by.x="row.names", by.y="Sample_ID")
tax.aitch.pcoa.dat %>%
    ggplot(mapping=aes(Axis.1, Axis.2, color=HIV_Status, label=Row.names)) +
    geom_point(size=4) +
    ggrepel::geom_label_repel(color="black")
    
```

### With tax by Cohort
```{r pcoa_aitch_Cohort_tax}
tax.aitch.pcoa.dat <- merge(tax.aitch.pcoa$vectors, metadata,
                              by.x="row.names", by.y="Sample_ID")
tax.aitch.pcoa.dat %>%
    ggplot(mapping=aes(Axis.1, Axis.2, color=Cohort, label=Row.names)) +
    geom_point(size=4) +
    ggrepel::geom_label_repel(color="black")
    
```

# Pathways
## Load and clean
```{r}
paths <- data.table::fread("../seq.f0.0.r0.0.nonhost.humann/all_pathabundance.tsv")

rownames(paths) <- paths$`# Pathway`
paths$`# Pathway` <- NULL
colnames(paths) <- colnames(paths) %>% gsub(pattern="_Abundance", 
                                            replacement="")

paths.tax.rows <- grepl("\\|", rownames(paths))

paths.tax <- paths[paths.tax.rows,]
rownames(paths.tax) <- rownames(paths)[paths.tax.rows]
paths.tax.rel <- t(t(paths.tax)/colSums(paths.tax))

paths.notax <- paths[!paths.tax.rows,]
rownames(paths.notax) <- rownames(paths)[!paths.tax.rows]
paths.notax.rel <- t(t(paths.notax)/colSums(paths.notax))
rownames(paths.notax.rel) <- rownames(paths.notax)
```

## Top Paths
```{r}
order.of.pathways <- order(rowSums(paths.notax.rel), decreasing=T)

path.notax.rel.sorted <- paths.notax.rel[order.of.pathways,] 
rownames(path.notax.rel.sorted) <- rownames(paths.notax.rel)[order.of.pathways]

pathway.means.sorted <- path.notax.rel.sorted %>%
    rowMeans() 

(pathway.means.sorted*100) %>% 
    round(digits=2) %>%
    head(n=20) %>%
    knitr::kable()
```