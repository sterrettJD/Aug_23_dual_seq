---
title: "MetaPhlAn vs Kraken vs 16S"
author: "John Sterrett"
date: "2023-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load("qiime2R",
               "phyloseq",
               "tidyverse")
```

# Load data
```{r}
s <- qiime2R::qza_to_phyloseq(features="../16s-data/tax_filtered_dual.qza",
                              taxonomy="../16s-data/taxonomy_dual.qza",
                              metadata="../16s-data/16S_meta.txt")

m <- data.table::fread("../seq.f0.0.r0.0.nonhost.humann/all_bugs_list.tsv",
                       data.table=F)
k <- data.table::fread("../seq.f0.0.r0.0.nonhost.kraken/Combined-taxonomy.tsv",
                       data.table=F)

metadata <- data.table::fread("../metadata.csv", data.table=F)
rownames(metadata) <- metadata$Sample
```

# Clean data
## Bracken to phyloseq
```{r}
pseq_from_bracken <- function(k, as.relative=TRUE){
    k.tax.table <- k[c("domain", "phylum", "class", 
                       "order", "family", "genus", "species")]
    
    if(as.relative==T){
        rel.cols <- colnames(k)[grepl(x=colnames(k), pattern="_frac")]
        k.feature.table <- k[,rel.cols]
        colnames(k.feature.table) <- gsub(
            colnames(k.feature.table), 
            pattern=".bracken_frac", replacement="")
    } 
    else if (as.relative==F) {
        num.cols <- colnames(k)[grepl(x=colnames(k), pattern="_frac")]
        k.feature.table <- k[,num.cols]
        colnames(k.feature.table) <- gsub(
            colnames(k.feature.table), 
            pattern=".bracken_num", replacement="")
    }
    k.pseq <- phyloseq::phyloseq(phyloseq::otu_table(k.feature.table, 
                                                     taxa_are_rows=T),
                       phyloseq::tax_table(as.matrix(k.tax.table)))

    return(k.pseq)
}

k.pseq <- pseq_from_bracken(k)
sample_data(k.pseq) <- sample_data(metadata)
```

## MetaPhlAn to phyloseq
```{r}
# grabs a certain level of taxonomic resolution from the metaphlan output
# defaults to the max level of resolution
filter_mphlan_by_taxonomy_level <- function(df, level="max"){
    tax.names <- rownames(df)
    levels.contained <- stringr::str_count(tax.names, "\\|")
    
    if (level=="max"){
        level <- max(levels.contained)
    }
    
    to.return <- df[levels.contained==level,]
    rownames(to.return) <- rownames(df)[levels.contained==level]
    return (to.return)
}


# Converts metaphlan formatted taxonomy names to a taxonomy table for phyloseq
# based on https://gist.github.com/lwaldron/512d1925a8102e921f05c5b25de7ec94
names_to_tax_table <- function(bugs){
    splitted <- strsplit(bugs, split="|", fixed=T)
    # create empty taxonomy matrix
    taxmat <- matrix(NA, 
                     ncol=max(sapply(splitted, length)), 
                     nrow=length(splitted))
    colnames(taxmat) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species", "Strain")[1:ncol(taxmat)]
    
    # add split taxonomy to the matrix
    for (i in 1:nrow(taxmat)){
        tax.resolution <- length(splitted[[i]])
        taxmat[i, 1:tax.resolution] <- splitted[[i]]
    }
    # remove the p__, f__, etc to indicate level
    taxmat <- gsub("[a-z]__", "", taxmat)
    
    return(taxmat)
}


rownames(m) <- m$`#clade_name`
m <- m %>% 
    dplyr::select(-c(`#clade_name`,
               NCBI_tax_id,
               additional_species))

# just get the lowest tax level. We can collapse again later
bugslist <- filter_mphlan_by_taxonomy_level(m, level="max")

# replace NA with 0
bugslist[is.na(bugslist)] <- 0

# check that our data are relative abundance adding up to 100 still
hundreds <- rep(100, ncol(bugslist))
names(hundreds) <- colnames(bugslist)
if (isFALSE(all.equal(target=hundreds, 
                      current=colSums(bugslist, na.rm=T), 
                      tolerance=0.001))){
    print("Data are NOT relative abundances summing to 100! Please check what's going on.")
} else {
    print("Samples sum to 100 (or close enough).")
}

# create tax table
bugs <- rownames(bugslist)
taxonomy.table <- names_to_tax_table(bugs)
rownames(taxonomy.table) <- bugs

# create phyloseq object
m.pseq <- phyloseq(otu_table=otu_table(bugslist, taxa_are_rows=T),
                 tax_table=tax_table(taxonomy.table),
                 sample_data=sample_data(metadata)
                 )
```

# Microshades