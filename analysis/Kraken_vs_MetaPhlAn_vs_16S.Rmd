---
title: "MetaPhlAn vs Kraken vs 16S"
author: "John Sterrett"
date: "2023-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load("qiime2R",
               "phyloseq",
               "tidyverse")
```

# Load data
```{r}
s <- qiime2R::qza_to_phyloseq(features="../16s-data/tax_filtered_dual.qza",
                              taxonomy="../16s-data/taxonomy_dual.qza",
                              metadata="../16s-data/16S_meta.txt")

m <- data.table::fread("../seq.f0.0.r0.0.nonhost.humann/all_bugs_list.tsv",
                       data.table=F)
k <- data.table::fread("../seq.f0.0.r0.0.nonhost.kraken/Combined-taxonomy.tsv",
                       data.table=F)

metadata <- data.table::fread("../metadata.csv", data.table=F)
rownames(metadata) <- metadata$Sample
```

# Clean data
## Bracken to phyloseq
```{r}
pseq_from_bracken <- function(k, as.relative=TRUE){
    k.tax.table <- k[c("domain", "phylum", "class", 
                       "order", "family", "genus", "species")]
    
    if(as.relative==T){
        rel.cols <- colnames(k)[grepl(x=colnames(k), pattern="_frac")]
        k.feature.table <- k[,rel.cols]
        colnames(k.feature.table) <- gsub(
            colnames(k.feature.table), 
            pattern=".bracken_frac", replacement="")
    } 
    else if (as.relative==F) {
        num.cols <- colnames(k)[grepl(x=colnames(k), pattern="_frac")]
        k.feature.table <- k[,num.cols]
        colnames(k.feature.table) <- gsub(
            colnames(k.feature.table), 
            pattern=".bracken_num", replacement="")
    }
    k.pseq <- phyloseq::phyloseq(phyloseq::otu_table(k.feature.table, 
                                                     taxa_are_rows=T),
                       phyloseq::tax_table(as.matrix(k.tax.table)))

    return(k.pseq)
}

k.pseq <- pseq_from_bracken(k)
sample_data(k.pseq) <- sample_data(metadata)
```

# Microshades